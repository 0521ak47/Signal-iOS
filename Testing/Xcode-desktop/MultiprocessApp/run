#!/bin/zsh

processes=(A B)
pids=()

rm -f db.yap
rm -f combined.out

# Run 4 parallel instances of the MultiprocessApp process which write and read from the database concurrently
# Kill them after 10 seconds, and sort the output to make sure they all see the writes in correct order

for process in $processes
do
    rm -f $process.out
    if [[ "A" == $process ]]
    then
        (./MultiprocessApp $process --special 2> $process.out) &
    else
        (./MultiprocessApp $process 2> $process.out) &
    fi
    pids+=$!
done;

sleep 10

for pid in $pids
do
    echo "Kill $pid"
    kill $pid
done;

cat {A,B}.out | sort > combined.out
